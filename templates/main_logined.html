{% extends "base.html" %}

{% block title %}log인곽{% endblock %}

{% block content %}
<main>
    <aside class="sidebar left-sidebar">
        <div class="widget">
            <h3>전체 게시판 목록</h3>
            <ul>
                <li><a href="/board/1">자유게시판</a></li>
                <li><a href="/board/2">정보게시판</a></li>
                <li><a href="/board/3">익명게시판</a></li>
                <li><a href="/board/4">공개게시판</a></li>
                <li><a href="/etacon/request">인곽콘 신청</a></li>
                <li><a href="/etacon/shop">인곽콘 상점</a></li>
            </ul>
        </div>
        
        <div class="widget profile-card-widget">
            <a href="{{ url_for('mypage') }}">
                <div class="profile-picture">
                    <img src="{{ url_for('static', filename=user.profile_image) }}" alt="프로필 사진">
                </div>
                <h4 class="nickname">{{ user.nickname }}</h4>
            </a>
            <div class="level-info">
                <span>Lv. {{ user.level }}</span>
                <div class="exp-bar">
                    <div class="exp-gauge" style="width: {{ user.exp/10 }}%;"></div>
                </div>
            </div>
            <div class="stats-info">
                <div>
                    <p class="stat-title">게시글</p>
                    <p class="stat-count">{{ user.post_count }}</p>
                </div>
                <div>
                    <p class="stat-title">댓글</p>
                    <p class="stat-count">{{ user.comment_count }}</p>
                </div>
            </div>
        </div>
    </aside>

    <section class="main-content">
        <div class="daily-meal">
            <div class="meal-item">
                <h4><span>조식</span></h4>
                <p class="meal-menu" id="breakfast-menu"><span class="loading-spinner"></span></p>
            </div>
            <div class="meal-item">
                <h4><span>중식</span></h4>
                <p class="meal-menu" id="lunch-menu"><span class="loading-spinner"></span></p>
            </div>
            <div class="meal-item">
                <h4><span>석식</span></h4>
                <p class="meal-menu" id="dinner-menu"><span class="loading-spinner"></span></p>
            </div>
            <div class="meal-item timetable-widget">
                <h4>
                    <span>시간표</span>
                    {% if user.hakbun %}
                        <span style="font-size: 0.8em; font-weight: normal; margin-left: 5px;">
                            ({{ (user.hakbun | string)[0] }}학년 {{ (user.hakbun | string)[1] }}반)
                        </span>
                    {% endif %}
                </h4>
                <ol class="timetable-list" id="timetable-list">
                    <li class="no-data" style="text-align: center; padding: 20px; color: #888;">
                        <span class="loading-spinner"></span> 불러오는 중...
                    </li>
                </ol>
            </div>
        </div>
        <div class="board-preview">
            <div class="board-column">
                <h3><a href="/board/1">자유게시판</a></h3>
                <ul>
                    {# 1. DB에서 불러온 게시글 목록을 먼저 출력합니다. #}
                    {% for post in free_posts %}
                    <li>
                        <a href="{{ url_for('post_detail', post_id=post.id) }}">{{ post.title }}</a>
                        <span>{{ post.updated_at|datetime }}</span>
                    </li>
                    {% endfor %}

                    {# 2. 만약 게시글 수가 5개 미만이라면, 빈 자리를 채우기 위해 5에서 게시글 수를 뺀 만큼 반복합니다. #}
                    {% if free_posts|length < 5 %}
                        {% for i in range(5 - free_posts|length) %}
                        <li>
                            <a href="#">게시글이 없습니다.</a>
                            <span></span>
                        </li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
            <div class="board-column">
                <h3><a href="/board/3">익명게시판</a></h3>
                <ul>
                    {# 1. 익명게시판도 동일한 방식으로 먼저 게시글을 출력합니다. #}
                    {% for post in info_posts %}
                    <li>
                        <a href="{{ url_for('post_detail', post_id=post.id) }}">{{ post.title }}</a>
                        <span>{{ post.updated_at|datetime }}</span>
                    </li>
                    {% endfor %}

                    {# 2. 익명게시판도 5개 미만일 경우 빈 자리를 채웁니다. #}
                    {% if info_posts|length < 5 %}
                        {% for i in range(5 - info_posts|length) %}
                        <li>
                            <a href="#">게시글이 없습니다.</a>
                            <span></span>
                        </li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
        </div>
    </section>

    <aside class="sidebar right-sidebar">
        <div class="widget search-widget">
            <form method="GET" action="{{ url_for('search') }}">
                <input type="text" name="q" placeholder="전체 게시판의 글을 검색하세요!">
            </form>
        </div>
        
        <div class="widget">
            <h3>실시간 인기글</h3>
            <ul>
                {# 1. DB에서 불러온 게시글 목록을 먼저 출력합니다. #}
                {% for post in trending_posts %}
                    <li><a href="{{ url_for('post_detail', post_id=post.id) }}">{{ post.title }}</a></li>
                {% endfor %}

                {# 2. 만약 게시글 수가 5개 미만이라면, 빈 자리를 채웁니다. #}
                {% if trending_posts|length < 5 %}
                    {% for i in range(5 - trending_posts|length) %}
                    <li><a href="#" style="color: #888; cursor: default;">글이 없습니다.</a></li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
        <div class="widget">
            <h3>HOT 게시글</h3>
             <ul>
                {# 1. HOT 게시물도 동일한 방식으로 먼저 출력합니다. #}
                {% for post in hot_posts %}
                    <li><a href="{{ url_for('post_detail', post_id=post.id) }}">{{ post.title }}</a><span>+{{ post.like_count }}</span></li>
                {% endfor %}

                {# 2. HOT 게시물도 5개 미만일 경우 빈 자리를 채웁니다. #}
                {% if hot_posts|length < 5 %}
                    {% for i in range(5 - hot_posts|length) %}
                    <li><a href="#" style="color: #888; cursor: default;">글이 없습니다.</a><span></span></li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
    </aside>
</main>

<style>
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD 형식
    
    // === 급식 정보 로드 (캐시 우선) ===
    const cachedBob = localStorage.getItem('bob_' + today);
    if (cachedBob) {
        // 캐시된 데이터가 있으면 즉시 표시
        const bobData = JSON.parse(cachedBob);
        document.getElementById('breakfast-menu').innerHTML = bobData.breakfast || '정보 없음';
        document.getElementById('lunch-menu').innerHTML = bobData.lunch || '정보 없음';
        document.getElementById('dinner-menu').innerHTML = bobData.dinner || '정보 없음';
    } else {
        // 캐시 없으면 서버에서 로드
        fetch('/api/bob')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // localStorage에 저장
                    localStorage.setItem('bob_' + today, JSON.stringify(data.data));
                    // 이전 날짜 캐시 삭제
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('bob_') && key !== 'bob_' + today) {
                            localStorage.removeItem(key);
                        }
                    });
                    document.getElementById('breakfast-menu').innerHTML = data.data.breakfast || '정보 없음';
                    document.getElementById('lunch-menu').innerHTML = data.data.lunch || '정보 없음';
                    document.getElementById('dinner-menu').innerHTML = data.data.dinner || '정보 없음';
                } else {
                    document.getElementById('breakfast-menu').textContent = '불러오기 실패';
                    document.getElementById('lunch-menu').textContent = '불러오기 실패';
                    document.getElementById('dinner-menu').textContent = '불러오기 실패';
                }
            })
            .catch(err => {
                document.getElementById('breakfast-menu').textContent = '오류 발생';
                document.getElementById('lunch-menu').textContent = '오류 발생';
                document.getElementById('dinner-menu').textContent = '오류 발생';
            });
    }

    // === 시간표 정보 로드 (캐시 우선) ===
    const cachedTimetable = localStorage.getItem('timetable_' + today);
    if (cachedTimetable) {
        // 캐시된 데이터가 있으면 즉시 표시
        const timetableData = JSON.parse(cachedTimetable);
        renderTimetable(timetableData);
    } else {
        // 캐시 없으면 서버에서 로드
        fetch('/api/timetable')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // localStorage에 저장
                    localStorage.setItem('timetable_' + today, JSON.stringify(data.data));
                    // 이전 날짜 캐시 삭제
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('timetable_') && key !== 'timetable_' + today) {
                            localStorage.removeItem(key);
                        }
                    });
                    renderTimetable(data.data);
                } else {
                    document.getElementById('timetable-list').innerHTML = '<li class="no-data" style="text-align: center; padding: 20px; color: #888;">오늘의 시간표 정보가 없습니다.</li>';
                }
            })
            .catch(err => {
                document.getElementById('timetable-list').innerHTML = '<li class="no-data" style="text-align: center; padding: 20px; color: #888;">시간표를 불러올 수 없습니다.</li>';
            });
    }

    function renderTimetable(data) {
        const timetableList = document.getElementById('timetable-list');
        if (data && data.length > 0) {
            let html = '';
            data.forEach(item => {
                const changedClass = item.changed ? 'changed-schedule' : '';
                const teacherSpan = item.teacher ? `<span class="teacher-name">(${item.teacher})</span>` : '';
                html += `
                    <li class="${changedClass}">
                        <span class="period">${item.period}교시</span>
                        <span class="subject">${item.subject} ${teacherSpan}</span>
                    </li>
                `;
            });
            timetableList.innerHTML = html;
        } else {
            timetableList.innerHTML = '<li class="no-data" style="text-align: center; padding: 20px; color: #888;">오늘의 시간표 정보가 없습니다.</li>';
        }
    }
});
</script>
{% endblock %}