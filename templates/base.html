<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="utf-8">
    <title>{% block title %}log인곽{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main_logined.css') }}">
    <meta property="og:image" content="https://i.namu.wiki/i/UX1a0RmaJfABnbuJcd-2PfCO6qfqFMXaVBkNYV0Hwjm007_uH2Cc0fJmv6M9g9BTfzXjUk3jwJpDa09YdZnf79GO_NiDd9uGp7dudqFfQVBz69OaFzGfhSmMbOGezsME4LUzp6meYGFLDHZ32cTifVistPL4rVyv_OyU1WOADOM.webp">
    <meta property="og:description" content="log인곽에 오신 것을 환영합니다!">
    <meta property="og:title" content="log인곽">
    <link rel="shortcut icon" href="">
    <meta name="title" content="log인곽">
    <meta name="keywords" content="log인곽">
    <meta name="description" content="인천과학고등학교 비공식 커뮤니티 log인곽입니다.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% block head %}{% endblock %}
</head>
<body>
    <div class="container">
        <header class="base-header">
            <div class="top-bar">
                <div class="logo"><a href="/">ISHS</a></div>
                <nav class="main-nav">
                    <ul>
                        <li><a href="/board/1">자유게시판</a></li>
                        <li><a href="/board/2">정보게시판</a></li>
                        <li><a href="#" onclick="alert('아직 지원되지 않는 기능입니다.')">지식iN곽</a></li>
                        <li><a href="#" onclick="alert('아직 지원되지 않는 기능입니다.')">면불 신청</a></li>
                        <li><a href="#" onclick="alert('아직 지원되지 않는 기능입니다.')">동아리</a></li>
                        <li><a href="#" onclick="alert('아직 지원되지 않는 기능입니다.')">학교 생활</a></li>
                    </ul>
                </nav>
                <div class="user-menu" style="display: flex; align-items: center;">
                    <div class="notification-bell" id="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notification-badge"></span>
                        <div class="notification-dropdown" id="notification-dropdown">
                            <div class="notification-header">알림</div>
                            <ul class="notification-list" id="notification-list">
                                </ul>
                        </div>
                    </div>
                    <div class="dropdown">
                        <a href="#" class="dropdown-toggle">{{ user.nickname }}님 ▼</a>
                        <div class="dropdown-menu">
                            <a href="{{ url_for('mypage') }}">마이페이지</a>
                            <a href="{{ url_for('logout') }}">로그아웃</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sub-nav-bar">
            </div>
        </header>

        {% block content %}{% endblock %}

        <footer class="base-footer">
            <p>&copy; 2025 Incheon Science HighSchool Community. All rights reserved.</p>
            <p style="margin-top: 10px; color: #999;">Made By. 32nd Kim Gyuwon</p>
            <nav>
                <a href="{{ url_for('yakgwan_view') }}">이용약관</a>
                <a href="{{ url_for('yakgwan_view') }}">개인정보처리방침</a>
                <a href="#">문의하기</a>
            </nav>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bell = document.getElementById('notification-bell');
            const dropdown = document.getElementById('notification-dropdown');
            const badge = document.getElementById('notification-badge');
            const list = document.getElementById('notification-list');

            async function fetchUnreadCount() {
                try {
                    const response = await fetch('/notifications/unread-count');
                    const data = await response.json();
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error fetching unread count:', error);
                }
            }

            async function fetchNotifications() {
                try {
                    const response = await fetch('/notifications');
                    const notifications = await response.json();
                    list.innerHTML = ''; // 기존 목록 비우기
                    if (notifications.length === 0) {
                        // 수정: 'no-notifications' 클래스를 가진 li 요소를 생성
                        list.innerHTML = '<li class="no-notifications"><a href="#" style="cursor: default;">새로운 알림이 없습니다.</a></li>';
                    } else {
                        notifications.forEach(n => {
                            const li = document.createElement('li');
                            if (n.is_read) {
                                li.classList.add('is-read');
                            }
                            let message = '';
                            if (n.action === 'comment') {
                                message = `<span class="actor">${n.actor_nickname}</span>님이 회원님의 게시글에 댓글을 남겼습니다.`;
                            } else if (n.action === 'reply') {
                                message = `<span class="actor">${n.actor_nickname}</span>님이 회원님의 댓글에 답글을 남겼습니다.`;
                            }
                            else if (n.action === 'hot_post') {
                                message = `회원님의 게시글이 추천 10개를 받아 <strong>HOT 게시물</strong>이 되었습니다!`;
                            }
                            
                            const link = document.createElement('a');
                            link.href = `/post/${n.post_id}`;
                            link.innerHTML = message;
                            link.onclick = async (e) => {
                                e.preventDefault();
                                await markAsRead(n.id);
                                window.location.href = link.href;
                            };
                            li.appendChild(link);
                            list.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                }
            }
            
            async function markAsRead(notificationId) {
                try {
                    await fetch(`/notifications/read/${notificationId}`, { 
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    });
                } catch (error) {
                    console.error('Error marking as read:', error);
                }
            }

            bell.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = dropdown.style.display === 'block';
                if (isVisible) {
                    dropdown.style.display = 'none';
                } else {
                    dropdown.style.display = 'block';
                    fetchNotifications();
                }
            });

            document.addEventListener('click', (e) => {
                if (!bell.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            
            fetchUnreadCount();
            setInterval(fetchUnreadCount, 30000); 
        });
    </script>
</body>
</html>