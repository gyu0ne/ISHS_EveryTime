{% extends "base.html" %}

{% block title %}log인곽 - 마이페이지{% endblock %}

{% block head %}
    <script src="{{ url_for('static', filename='js/my_page.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/my_page.css') }}">
    <script>
        function confirmDeleteAccount() {
        // 비밀번호만 묻도록 prompt 수정
        const password = prompt("계정을 삭제하시려면 비밀번호를 입력해주세요. 이 작업은 되돌릴 수 없습니다.");

        // 사용자가 취소 버튼을 누르지 않았고, 무언가 입력했다면
        if (password !== null) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('delete_account') }}";

            const passwordInput = document.createElement('input');
            passwordInput.type = 'hidden';
            passwordInput.name = 'password';
            passwordInput.value = password; // 사용자가 입력한 비밀번호
            form.appendChild(passwordInput);

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
        // 사용자가 '취소'를 누르면 아무 작업도 하지 않음
    }
    </script>
{% endblock %}

{% block content %}
    <div class="mypage-container">
        <main class="content-wrapper">
            <aside class="profile-sidebar">
                <div class="card profile-card">
                    <div class="profile-picture">
                        <img src="{{ url_for('static', filename=profile_image) }}" alt="프로필 사진">
                        <button class="change-pic-btn" id="change-pic-btn">변경</button>
                    </div>
                    <h2 class="nickname">{{ nickname }}</h2>
                    <div class="level-info">
                        <span>Lv. {{ level }}</span>
                        <div class="exp-bar">
                            <div class="exp-gauge" style="width: {{ exp/10 }}%;"></div>
                        </div>
                        <span class="exp-text">{{ exp }} / 1000 EXP</span>
                    </div>
                    <div class="point-info">
                        <p>캐시: <span>{{ point }} P</span></p>
                    </div>
                    <div class="stats-info">
                        <div>
                            <p class="stat-title">게시글</p>
                            <p class="stat-count">{{ post_count }}</p>
                        </div>
                        <div>
                            <p class="stat-title">댓글</p>
                            <p class="stat-count">{{ comment_count }}</p>
                        </div>
                    </div>
                </div>

                <div class="card user-details">
                    <h3>개인 정보</h3>
                    <ul>
                        <li><span>이름</span><strong>{{ name }}</strong></li>
                        <li><span>학번</span><strong>{{ hakbun }}</strong></li>
                        <li><span>기수</span><strong>{{ gen }}기</strong></li>
                        <li><span>생년월일</span><strong>{{ birth }}</strong></li>
                        <li><span>가입일자</span><strong>{{ join_date }}</strong></li>
                    </ul>
                </div>

                <div class="card profile-edit">
                    <h3>프로필 편집</h3>
                    <form action="{{ url_for('update_profile_info') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <textarea name="profile_message" placeholder="프로필 소개 메시지를 입력하세요. (최대 100자)">{{ user.profile_message }}</textarea>
                        
                        <select name="club1">
                            <option value="" {% if not user.clubhak %}selected{% endif %}>학술 동아리 선택</option>
                            {% for club in academic_clubs %}
                            <option value="{{ club }}" {% if user.clubhak == club %}selected{% endif %}>{{ club }}</option>
                            {% endfor %}
                        </select>

                        <select name="club2">
                            <option value="" {% if not user.clubchi %}selected{% endif %}>취미 동아리 선택</option>
                            {% for club in hobby_clubs %}
                            <option value="{{ club }}" {% if user.clubchi == club %}selected{% endif %}>{{ club }}</option>
                            {% endfor %}
                        </select>

                        <select name="club3">
                            <option value="" {% if not user.clubjin %}selected{% endif %}>진로탐색 동아리 선택</option>
                            {% for club in career_clubs %}
                            <option value="{{ club }}" {% if user.clubjin == club %}selected{% endif %}>{{ club }}</option>
                            {% endfor %}
                        </select>

                        <div class="profile-public-toggle">
                            <label for="profile_public">프로필 공개</label>
                            <label class="switch">
                                <input type="checkbox" id="profile_public" name="profile_public" {% if user.profile_public == 1 %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-save">저장</button>
                    </form>
                </div>
                
                <div class="card account-management">
                    <h3>계정 관리</h3>
                    <button class="btn" onclick="location.href='{{ url_for('change_password') }}'">비밀번호 변경</button>
                    <button class="btn" onclick="location.href='/logout'">로그아웃</button>
                    <button class="btn btn-delete" onclick="confirmDeleteAccount()">계정 삭제</button>
                </div>
            </aside>

            <section class="activity-content">
                <nav class="activity-tabs">
                    <ul>
                        <li><a href="#" id="posts-tab" class="active">작성 게시글</a></li>
                        <li><a href="#" id="comments-tab">작성 댓글</a></li>
                    </ul>
                </nav>

                <div id="posts-list" class="activity-list">
                    <ul>
                        {% if user_posts %}
                            {% for post in user_posts %}
                            <li>
                                <div class="post-info">
                                    <a href="{{ url_for('post_detail', post_id=post.id) }}" class="post-title">{{ post.title }}</a>
                                    <p class="post-meta">{{ post.board_name }} ・ {{ post.updated_at|datetime }}</p>
                                </div>
                                <div class="post-stats">
                                    <span>댓글 {{ post.comment_count }}</span>
                                </div>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="no-posts-message">작성한 게시글이 없습니다.</li>
                        {% endif %}
                    </ul>
                </div>

                <div id="comments-list" class="activity-list" style="display: none;"> <ul>
                        {% if user_comments %}
                            {% for comment in user_comments %}
                            <li>
                                <div class="post-info">
                                    <p class="comment-content">{{ comment.content }}</p>
                                    <a href="{{ url_for('post_detail', post_id=comment.post_id) }}" class="post-meta">
                                        원본 글: {{ comment.post_title }} ・ {{ comment.updated_at|datetime }}
                                    </a>
                                </div>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="no-posts-message">작성한 댓글이 없습니다.</li>
                        {% endif %}
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <div id="profile-image-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>프로필 사진 변경</h2>
            <form action="{{ url_for('update_profile_image') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="file-input-wrapper">
                    <input type="file" name="profile_image" id="profile-image-input" accept="image/*" required>
                    <label for="profile-image-input" class="file-input-label">파일 선택</label>
                </div>
                <p class="file-name-display">선택된 파일 없음</p>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="modal-close-btn">취소</button>
                    <button type="submit" class="btn-submit">변경하기</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}